<?xml version="1.0" encoding="utf-8"?>

<!--This file is part of Freedom Maker.-->

<!--This program is free software: you can redistribute it and/or modify-->
<!--it under the terms of the GNU General Public License as published by-->
<!--the Free Software Foundation, either version 3 of the License, or-->
<!--(at your option) any later version.-->

<!--This program is distributed in the hope that it will be useful,-->
<!--but WITHOUT ANY WARRANTY; without even the implied warranty of-->
<!--MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the-->
<!--GNU General Public License for more details.-->

<!--You should have received a copy of the GNU General Public License-->
<!--along with this program.  If not, see <http://www.gnu.org/licenses/>.-->

<cruise xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="cruise-config.xsd" schemaVersion="90">
    <server artifactsdir="artifacts" agentAutoRegisterKey="1cf6988c-6f83-4038-b4da-514653ffcc3f"
            commandRepositoryLocation="default" serverId="d7655976-addc-4af1-8fb3-f22ed543056c"/>
    <pipelines group="stable">
        <pipeline name="freedom-maker-amd64" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">amd64</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-i386" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">i386</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-raspberry" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">raspberry</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-raspberry2" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">raspberry2</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-dreamplug" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">dreamplug</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-virtualbox-i386" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">virtualbox-i386</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-virtualbox-amd64" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">virtualbox-amd64</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-qemu-i386" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">qemu-i386</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-qemu-amd64" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">qemu-amd64</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-beaglebone" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">beaglebone</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-cubieboard2" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">cubieboard2</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-cubietruck" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">cubietruck</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-a20-olinuxino-lime" isLocked="false" template="freedom-maker">
            <params>
                <param name="target">a20-olinuxino-lime</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-a20-olinuxino-lime2" isLocked="false"
                  template="freedom-maker">
            <params>
                <param name="target">a20-olinuxino-lime2</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-a20-olinuxino-micro" isLocked="false"
                  template="freedom-maker">
            <params>
                <param name="target">a20-olinuxino-micro</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
            </materials>
        </pipeline>
    </pipelines>
    <pipelines group="dev">
        <pipeline name="plinth" isLocked="false">
            <timer>0 0 18 1/1 * ? *</timer>
            <materials>
                <git url="https://github.com/freedombox/Plinth.git" shallowClone="true"
                     dest="plinth_github" materialName="Plinth_Github"/>
                <git url="git://anonscm.debian.org/freedombox/plinth.git" dest="plinth_alioth"
                     materialName="Plinth_Alioth"/>
            </materials>
            <stage name="test" cleanWorkingDir="true">
                <jobs>
                    <job name="unit_test">
                        <tasks>
                            <exec command="python3" workingdir="plinth_github">
                                <arg>setup.py</arg>
                                <arg>test</arg>
                                <runif status="passed"/>
                            </exec>
                        </tasks>
                        <resources>
                            <resource>unit_test</resource>
                        </resources>
                    </job>
                </jobs>
            </stage>
            <stage name="package">
                <jobs>
                    <job name="build_deb">
                        <tasks>
                            <exec command="mv">
                                <arg>plinth_alioth/debian</arg>
                                <arg>plinth_github</arg>
                                <runif status="passed"/>
                            </exec>
                            <exec command="sudo" workingdir="plinth_github">
                                <arg>mk-build-deps</arg>
                                <runif status="passed"/>
                            </exec>
                            <exec command="sudo" workingdir="plinth_github">
                                <arg>bash</arg>
                                <arg>-c</arg>
                                <arg>dpkg -i plinth-build-deps_*.deb</arg>
                                <runif status="passed"/>
                            </exec>
                            <exec command="sudo">
                                <arg>apt</arg>
                                <arg>install</arg>
                                <arg>-y</arg>
                                <arg>-f</arg>
                                <runif status="passed"/>
                            </exec>
                            <exec command="debuild" workingdir="plinth_github">
                                <arg>-i</arg>
                                <arg>-us</arg>
                                <arg>-uc</arg>
                                <arg>-b</arg>
                                <runif status="passed"/>
                            </exec>
                        </tasks>
                        <resources>
                            <resource>gbp</resource>
                        </resources>
                        <artifacts>
                            <artifact src="*.deb" dest="plinth.deb"/>
                        </artifacts>
                    </job>
                </jobs>
            </stage>
        </pipeline>
        <pipeline name="freedom-maker-amd64_dev" template="freedom-maker_dev">
            <params>
                <param name="target">amd64</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
                <pipeline pipelineName="plinth" stageName="package" materialName="Plinth_Deb"/>
            </materials>
        </pipeline>
        <pipeline name="freedom-maker-a20-olinuxino-lime2_dev" template="freedom-maker_dev">
            <params>
                <param name="target">a20-olinuxino-lime2</param>
                <param name="apt_host">10.0.2.2:3142</param>
            </params>
            <materials>
                <git url="https://github.com/freedombox/freedom-maker.git" shallowClone="true"
                     dest="freedommaker_github" autoUpdate="false"
                     materialName="FreedomMaker_Github"/>
                <pipeline pipelineName="plinth" stageName="package" materialName="Plinth_Deb"/>
            </materials>
        </pipeline>
    </pipelines>
    <templates>
        <pipeline name="freedom-maker">
            <stage name="build" cleanWorkingDir="true">
                <jobs>
                    <job name="build">
                        <tasks>
                            <exec command="python3" workingdir="freedommaker_github">
                                <arg>-m</arg>
                                <arg>freedommaker</arg>
                                <arg>--build-mirror=http://#{apt_host}/debian</arg>
                                <arg>#{target}</arg>
                                <runif status="passed"/>
                            </exec>
                        </tasks>
                        <resources>
                            <resource>img</resource>
                        </resources>
                        <artifacts>
                            <artifact src="freedommaker_github/build/*.xz"/>
                            <artifact src="freedommaker_github/build/*.log"/>
                        </artifacts>
                    </job>
                </jobs>
            </stage>
        </pipeline>
        <pipeline name="freedom-maker_dev">
            <stage name="build">
                <jobs>
                    <job name="build">
                        <tasks>
                            <fetchartifact pipeline="plinth" stage="package" job="build_deb"
                                           srcfile="plinth.deb" dest="freedommaker_github">
                                <runif status="passed"/>
                            </fetchartifact>
                            <exec command="python3" workingdir="freedommaker_github">
                                <arg>-m</arg>
                                <arg>freedommaker</arg>
                                <arg>--build-mirror=http://#{apt_host}/debian</arg>
                                <arg>#{target}</arg>
                                <arg>--custom-package=plinth.deb</arg>
                                <runif status="passed"/>
                            </exec>
                        </tasks>
                        <resources>
                            <resource>img</resource>
                        </resources>
                        <artifacts>
                            <artifact src="freedommaker_github/build/*.xz"/>
                            <artifact src="freedommaker_github/build/*.log"/>
                        </artifacts>
                    </job>
                </jobs>
            </stage>
        </pipeline>
    </templates>
    <agents>
    </agents>
</cruise>
