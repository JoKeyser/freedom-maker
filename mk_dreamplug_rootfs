#!/bin/bash
# 
# Copyright 2011 by Bdale Garbee <bdale@gag.com>
# 
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
# 

# based on work by <ivan@sanchezortega.es>, who released his script under
# the following license terms:
#  ----------------------------------------------------------------------------
#  "THE BEER-WARE LICENSE" (Revision 42):
#  As long as you retain this notice you can do whatever you want with 
#  this stuff. If we meet some day, and you think this stuff is worth it, 
#  you can buy me a beer in return.
#  ----------------------------------------------------------------------------

# mk_dreamplug_rootfs
#
# Runs multistrap and readies the resulting root filesystem to silently 
# complete package configuration on the first boot-up.

# We don't tolerate errors.
set -e

# users
hostname='freedombox'
rootpassword='freedom'
user='fbx'
userpassword='frdm'
export rootpassword
export user
export userpassword

# where to build images, etc
basedir=`pwd`/build
source=`pwd`/source
target=$basedir/dreamplug
tmpdir=$basedir/tmp
pkgcache=$tmpdir/aptcache
homedir=$target/home/$user

#
# intro
#

# make the directories we'll need.
mkdir -p $target
rm -rf $target/*

mkdir -p $tmpdir
mkdir -p $pkgcache
mkdir -p $target/var/cache/apt/ && mount -o bind $pkgcache $target/var/cache/apt/
mkdir -p $target/var/cache/apt/archives
mkdir -p $target/tmp/kernel
mkdir -p $target/usr/bin

# multistrap
echo "Multistrapping..."
multistrap -f fbx-armel.conf -d $target
rm -f $target/etc/apt/sources.list.d/multistrap-debian.list


#
# Copy!
#

echo "Copying the source directory to the FreedomBox root."
# don't leave target image containing apt config of the build host
# FIXME -- we could do this better, using ftp.debian.org is a temporary hack
#echo "clean up target apt configuration"
cp -r "${source}/*" "${target}/"


#
# Post-copy configuration.
#

echo "Adding a few FreedomBox projects to the image."

git clone git://github.com/NickDaly/Plinth.git $homedir/plinth
git clone git://github.com/jvasile/freedombox-privoxy $homedir/freedombox-privoxy
git clone git://github.com/jvasile/withsqlite.git $homedir/withsqlite
hg clone https://hg@bitbucket.org/nickdaly/plugserver $homedir/plugserver
chown -R 1000:1000 $homedir


#
# cleanup and finalize
#

bin/finalize $target $hostname

echo "Syncing..."
sync

echo "Finished. You may now copy the rootfs to the plug."
